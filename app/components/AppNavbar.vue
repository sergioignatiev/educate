<template>
  <!-- Navbar: –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω, —á–µ—Ä–Ω—ã–µ –Ω–∞–¥–ø–∏—Å–∏, –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ md –∏ –≤—ã—à–µ -->
  <!-- –î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ç–∏–∫–∏-–ø–æ–≤–µ–¥–µ–Ω–∏–µ (sticky top-0 z-50) –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –Ω–∞–≤–±–∞—Ä–∞ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ -->
  <nav class="hidden md:block bg-white/90 backdrop-blur-sm shadow-md border-b border-gray-100 sticky top-0 z-50">
    
    <!-- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ 1280px (max-w-7xl) –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –µ–≥–æ -->
    <!-- –£–º–µ–Ω—å—à–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–∞–¥–¥–∏–Ω–≥ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –Ω–∞ –º–µ–Ω—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö (px-4) -->
    <div class="max-w-7xl mx-auto px-4 lg:px-6 h-16 flex items-center justify-between xl:space-x-6 space-x-4">

      <!-- 1. –õ–æ–≥–æ—Ç–∏–ø (–°–ª–µ–≤–∞) -->
      <NuxtLink to="/" class="flex-shrink-0">
        <!-- 
          –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 1 (–ë–æ–ª—å—à–æ–µ): –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö >= 1000px (xl:block)
          –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø.
        -->
        <img 
          src="https://nuxt-shopping-woad.vercel.app/logo2.png" 
          alt="Bald-e Logo" 
          class="h-9 w-auto hidden xl:block"
        >
        <!-- 
          –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 2 (–ú–∞–ª–µ–Ω—å–∫–æ–µ): –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö < 1000px (xl:hidden)
          –ò—Å–ø–æ–ª—å–∑—É–µ—Ç favicon.ico –∏ —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä.
        -->
        <img 
          src="/favicon.ico" 
          alt="Bald-e Icon" 
          class="h-9 w-9 xl:hidden"
        >
      </NuxtLink>
      
      <!-- 2. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ù–∞–≤–∏–≥–∞—Ü–∏—è (–°—Å—ã–ª–∫–∏ + –ü–æ–∏—Å–∫) -->
      <!-- –£–º–µ–Ω—å—à–∞–µ–º space-x-8 –¥–æ space-x-4 –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö –Ω–∏–∂–µ xl -->
      <div class="flex items-center xl:space-x-8 space-x-4 flex-grow">
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏: –£–º–µ–Ω—å—à–∞–µ–º space-x-2 –¥–æ space-x-1 –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö –Ω–∏–∂–µ xl -->
        <!-- –ò–°–ö–£–õ–Æ–ß–ê–ï–ú –ü–û–°–õ–ï–î–ù–ò–ô –≠–õ–ï–ú–ï–ù–¢ (–ö–æ—Ä–∑–∏–Ω–∞), –∏—Å–ø–æ–ª—å–∑—É—è slice(0, 3) -->
        <ul class="flex xl:space-x-2 space-x-1">
          <li v-for="nav in navigation.slice(0, 3)" :key="nav.id">
            <NuxtLink
              :to="nav.path"
              class="text-gray-700 hover:text-indigo-600 px-2 py-2 rounded-lg text-sm font-semibold tracking-wide transition duration-200 ease-in-out"
            >
              {{ nav.label }}
            </NuxtLink>
          </li>
        </ul>

        <!-- –û–ë–ï–†–¢–ö–ê –î–õ–Ø –ü–û–ò–°–ö–ê –ò –î–†–û–ü–î–ê–£–ù–ê (relative) -->
        <!-- flex-grow –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ -->
 <div class="relative flex flex-grow max-w-lg" @keydown="handleKeydown">

  <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –ü–û–õ–Ø –ü–û–ò–°–ö–ê -->
  <div class="flex flex-grow h-10 rounded-lg overflow-hidden border border-gray-400 shadow-sm">

    <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
    <input
      v-model="searchQuery"
      @focus="handleFocus"
      @blur="handleBlur"
      type="text"
      placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..."
      class="flex-grow px-3 py-2 bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 border-transparent w-full text-base"
    />

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ (–∫—Ä–µ—Å—Ç–∏–∫) -->
    <button
      v-if="searchQuery.length > 0"
      @mousedown.prevent="searchQuery = ''"
      class="w-10 flex items-center justify-center text-gray-400 hover:text-gray-600 transition"
    >
      ‚úï
    </button>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
    <button class="bg-indigo-600 hover:bg-indigo-700 w-12 flex items-center justify-center transition duration-150">
      <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>

  <!-- –î–†–û–ü–î–ê–£–ù -->
  <div v-if="isSearchActive && searchQuery.length > 0" class="absolute top-full mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-xl z-50 p-4">
    <h3 class="text-xs font-semibold uppercase text-gray-500 mb-2">{{ findedItems.length>0?"–ù–∞—à–ª–æ—Å—å":"–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" }}</h3>
    <ul class="space-y-1">
      <li
        v-for="(item, index) in findedItems"
        :key="item.id"
        :class="[
          'p-2 cursor-pointer text-gray-800 border-b border-gray-100 last:border-b-0 transition duration-150',
          index === focusedItemIndex ? 'bg-indigo-100 ring-2 ring-indigo-300' : 'hover:bg-gray-50'
        ]"
        @mousedown.prevent="selectItem(index)"
      >
        <NuxtLink :to="`/products/${item.id}`"> {{ item.title }}</NuxtLink>
      </li>
      <li class="p-2 text-sm text-gray-600 bg-gray-50 rounded-md mt-2">
        –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å: **{{ searchQuery }}**
      </li>
    </ul>
  </div>
</div>

          <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –ü–û–õ–Ø –ü–û–ò–°–ö–ê (–æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞) -->
            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ border-gray-400 -->
  
      </div>

      <!-- 3. –ö–æ—Ä–∑–∏–Ω–∞ (–°–ø—Ä–∞–≤–∞, —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∞ –∏ —Å—á–µ—Ç—á–∏–∫) -->
      <NuxtLink
          :to="navigation[3]?.path"
          class="flex items-center space-x-1 text-gray-900 hover:text-indigo-600 transition duration-150 p-2 rounded-lg relative group"
          aria-label="–ö–æ—Ä–∑–∏–Ω–∞"
        >
          <!-- –ò–∫–æ–Ω–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã (—Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ - —Ç–µ–º–Ω–æ-—Å–µ—Ä—ã–π, —Ö–æ–≤–µ—Ä - —Å–∏–Ω–∏–π) -->
          <span class="text-3xl transition duration-200 group-hover:scale-110 transform">üõí</span>
          
          <!-- –°—á–µ—Ç—á–∏–∫: —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–∏–Ω–∏–π, —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –±–µ–ª—ã–π -->
          <span class="absolute top-0 right-1 bg-indigo-600 text-xs font-bold w-4 h-4 rounded-full flex items-center justify-center text-white">{{ basket?.length }}</span>
        </NuxtLink>
    </div>
  </nav>
</template>

<script lang="ts" setup>
import { ref, computed } from 'vue'; 
import { type User } from '~/interfaces/user';
import { useCounterStore,storeToRefs } from '#imports';
import { useRouter } from 'vue-router'

const store = useCounterStore()
const {data, basket} = storeToRefs(store)

const router = useRouter()

// -- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ö–õ–ê–í–ò–ê–¢–£–†–ù–û–ô –ù–ê–í–ò–ì–ê–¶–ò–ò --
const focusedItemIndex = ref(-1); // -1: —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞

const navigation = [
  {id: 1, path: '/', label: '–ì–ª–∞–≤–Ω–∞—è'},
  {id: 2, path: '/products', label: '–¢–æ–≤–∞—Ä—ã'},
  {id: 3, path: '/admin', label: "–ê–¥–º–∏–Ω"},
  {id: 4, path: '/basket', label: "–ö–æ—Ä–∑–∏–Ω–∞"} 
]

const searchQuery = ref('');
const isSearchActive = ref(false);

const findedItems = computed(() => {
    return data.value.filter((i:User) => i.title.toLowerCase().includes(searchQuery.value.toLowerCase()))
})

// –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ Enter –∏–ª–∏ –∫–ª–∏–∫—É)
const selectItem = async (index: number) => {
  const selectedItem = findedItems.value[index];
  if (selectedItem) {
    await router.push(`/products/${selectedItem.id}`);

    // –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ ‚Äî –≥–æ—Ç–æ–≤–∏–º –≤–≤–æ–¥ –∫ –Ω–æ–≤–æ–º—É –ø–æ–∏—Å–∫—É
    searchQuery.value = '';
    isSearchActive.value = true;
    focusedItemIndex.value = -1;

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –≤ –ø–æ–ª–µ
    requestAnimationFrame(() => {
      const input = document.querySelector('input[placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..."]') as HTMLInputElement;
      input?.focus();
    });
  }
}

const handleKeydown = (event: KeyboardEvent) => {
    if (!isSearchActive.value || searchQuery.value.length === 0) return;

    const resultsCount = findedItems.value.length;
    if (resultsCount === 0) return;

    if (event.key === 'ArrowDown') {
        event.preventDefault();
        if (focusedItemIndex.value < resultsCount - 1) {
            focusedItemIndex.value++;
        } else {
            focusedItemIndex.value = 0;
        }
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        if (focusedItemIndex.value > 0) {
            focusedItemIndex.value--;
        } else {
            focusedItemIndex.value = -1; 
        }
    } else if (event.key === 'Enter') {
        event.preventDefault();
        if (focusedItemIndex.value !== -1) {
            selectItem(focusedItemIndex.value);
        } else if (findedItems.value.length > 0) {
            selectItem(0); // –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π
        }
    }
};

const handleFocus = () => {
    focusedItemIndex.value = -1;
    isSearchActive.value = true;
};

const handleBlur = () => {
    setTimeout(() => {
        isSearchActive.value = false;
    }, 200);
};
</script>


<style>
/* NuxtLink: –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Å—ã–ª–∫–∏. */
ul li .router-link-active, 
ul li .router-link-exact-active {
  /* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: —Ñ–æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–º, —á—Ç–æ–±—ã –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É */
  color: #1f2937; /* gray-800 */
  background-color: #f3f4f6 !important; /* bg-gray-100 */
}
</style>
